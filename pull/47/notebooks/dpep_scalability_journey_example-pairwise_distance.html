<!DOCTYPE html>

<html lang="en" data-content_root="../">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="viewport" content="width=device-width, initial-scale=1" />

    <!-- Google tag (gtag.js) -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-KVSVYMBQ0W"></script>
    <script>
        window.dataLayer = window.dataLayer || [];
        function gtag(){dataLayer.push(arguments);}
        gtag('js', new Date());
        gtag('config', 'G-KVSVYMBQ0W');
    </script>
    
    <title>Pairwise Distance: Open-Source XPU Programming with Data Parallel Extensions for Python* language &#8212; Data Parallel Extensions for Python* 0.1 documentation</title>
    <link rel="stylesheet" type="text/css" href="../_static/pygments.css?v=fa44fd50" />
    <link rel="stylesheet" type="text/css" href="../_static/sdc.css?v=8cc1021e" />
    <link rel="stylesheet" type="text/css" href="../_static/nbsphinx-code-cells.css" />
    
    <script src="../_static/documentation_options.js?v=2709fde1"></script>
    <script src="../_static/doctools.js?v=888ff710"></script>
    <script src="../_static/sphinx_highlight.js?v=dc90522c"></script>
    <script crossorigin="anonymous" integrity="sha256-Ae2Vz/4ePdIu6ZyI/5ZGsYnb+m0JlOmKPjt6XZ9JJkA=" src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.4/require.min.js"></script>
    <script>window.MathJax = {"tex": {"inlineMath": [["$", "$"], ["\\(", "\\)"]], "processEscapes": true}, "options": {"ignoreHtmlClass": "tex2jax_ignore|mathjax_ignore|document", "processHtmlClass": "tex2jax_process|mathjax_process|math|output_area"}}</script>
    <script defer="defer" src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
    <script type="text/javascript" src="../_static/sidebar.js"></script>
    <script type="text/javascript" src="../_static/copybutton.js"></script>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link href='https://fonts.googleapis.com/css?family=Source+Sans+Pro:200,600' rel='stylesheet' type='text/css'/>

  </head><body>
<div class="topbar">
  <a class="brand" title="Intel Python projects" href="../other_intel_python_projects.html"></a>
  <a class="brand_sdc" title="Documentation Home" href="../index.html"></a>

  <ul>
    <li><a class="exampleslink" title="Examples" href="../examples.html"></a></li>
    <li><a class="issueslink" title="Issues" href="https://community.intel.com/t5/Intel-Distribution-for-Python/bd-p/distribution-python"></a></li>
    <li><a class="emaillink" title="Email" href="mailto:scripting@intel.com"></a></li>
    <li><a class="homelink" title="GitHub" href="https://github.com/IntelPython/DPEP"></a></li>
    <li>
      
      
<form action="../search.html" method="get">
  <input type="text" name="q" placeholder="Search" />
  <input type="hidden" name="check_keywords" value="yes" />
  <input type="hidden" name="area" value="default" />
</form>
      
    </li>
  </ul>
</div>

<div class="related">
    <h3>Navigation</h3>
    <ul>
      <li>
	<a href="../index.html">Data Parallel Extensions for Python* 0.1 documentation</a>
	 &#187;
      </li>
      
       
    </ul>
</div>
  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body" role="main">
            
  <section id="Pairwise-Distance:-Open-Source-XPU-Programming-with-Data-Parallel-Extensions-for-Python*-language">
<h1>Pairwise Distance: Open-Source XPU Programming with Data Parallel Extensions for Python* language<a class="headerlink" href="#Pairwise-Distance:-Open-Source-XPU-Programming-with-Data-Parallel-Extensions-for-Python*-language" title="Link to this heading">¶</a></h1>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[21]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># SPDX-FileCopyrightText: 2020 - 2023 Intel Corporation</span>
<span class="c1">#</span>
<span class="c1"># SPDX-License-Identifier: Apache-2.0</span>
</pre></div>
</div>
</div>
<p>In this notebook, learn how to compute pairwise distance, a very popular distance metric applicable in many applications such as machine learning, geospatial, biology, HPC, and so on.</p>
<p>This tutorial will cover how Data Parallel Extension for NumPy* and Data Parallel Extension for Numba* can be used to compute pairwise distance in NumPy* code efficiently and scale performance through open-source heterogenous computing and DPC++/SYCL compilation.</p>
<section id="Simple-NumPy-Script">
<h2>Simple NumPy Script<a class="headerlink" href="#Simple-NumPy-Script" title="Link to this heading">¶</a></h2>
<p>Here is a simple NumPy* script running pairwise distance on CPU - this is a normal NumPy script without any Data Parallel Extensions for Python* language (dpep) products included. We are using Intel® Optimizations for NumPy* for out-of-box acceleration powered by Intel® oneAPI Math Kernel Library optimizations. This can be downloaded via Anaconda using the command <code class="docutils literal notranslate"><span class="pre">conda</span> <span class="pre">install</span> <span class="pre">-c</span> <span class="pre">intel</span> <span class="pre">numpy</span></code> or as part of <a class="reference external" href="https://www.intel.com/content/www/us/en/developer/tools/oneapi/distribution-for-python.html">Intel® Distribution for
Python*</a>.</p>
<p>We will also record the time it takes to compute pariwise distance with this script for performance purposes.</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[1]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">warnings</span>
<span class="n">warnings</span><span class="o">.</span><span class="n">filterwarnings</span><span class="p">(</span><span class="s2">&quot;ignore&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[2]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">time</span>

<span class="c1">#compute pairwise distance</span>
<span class="k">def</span> <span class="nf">pairwise_distance</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">distance</span><span class="p">):</span>
    <span class="n">data_sqr</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">square</span><span class="p">(</span><span class="n">data</span><span class="p">),</span> <span class="n">dtype</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">data</span><span class="o">.</span><span class="n">T</span><span class="p">,</span> <span class="n">distance</span><span class="p">)</span>
    <span class="n">distance</span> <span class="o">*=</span> <span class="o">-</span><span class="mi">2</span>
    <span class="n">np</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">distance</span><span class="p">,</span> <span class="n">data_sqr</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">data_sqr</span><span class="o">.</span><span class="n">size</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span> <span class="n">distance</span><span class="p">)</span>
    <span class="n">np</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">distance</span><span class="p">,</span> <span class="n">data_sqr</span><span class="p">,</span> <span class="n">distance</span><span class="p">)</span>
    <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">distance</span><span class="p">,</span> <span class="n">distance</span><span class="p">)</span>

<span class="n">data</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">ranf</span><span class="p">((</span><span class="mi">10</span><span class="o">*</span><span class="mi">1024</span><span class="p">,</span><span class="mi">3</span><span class="p">))</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
<span class="n">distance</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">(</span><span class="n">shape</span><span class="o">=</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">data</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>


<span class="c1">#time pairwise distance calculations</span>
<span class="n">start</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
<span class="n">pairwise_distance</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">distance</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Time to Compute Pairwise Distance with Stock NumPy on CPU:&quot;</span><span class="p">,</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">start</span><span class="p">)</span>
<br/></pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
Time to Compute Pairwise Distance with Stock NumPy on CPU: 2.764047861099243
</pre></div></div>
</div>
</section>
<section id="Data-Parallel-Extension-for-NumPy*-Running-on-CPU-for-Additional-Speed-Up">
<h2>Data Parallel Extension for NumPy* Running on CPU for Additional Speed-Up<a class="headerlink" href="#Data-Parallel-Extension-for-NumPy*-Running-on-CPU-for-Additional-Speed-Up" title="Link to this heading">¶</a></h2>
<p>Now let’s convert this script into a Data Parallel Extension for NumPy* (dpnp) Script that can be run on any SYCL-supported device (CPU, GPU, etc) by a simple import statement change.</p>
<p>Instead of <code class="docutils literal notranslate"><span class="pre">import</span> <span class="pre">numpy</span> <span class="pre">as</span> <span class="pre">np</span></code>, let’s replace this statement with <code class="docutils literal notranslate"><span class="pre">import</span> <span class="pre">dpnp</span> <span class="pre">as</span> <span class="pre">np</span></code>. That is the only change required!</p>
<p>The script will run on a Intel GPU SYCL-device by default, if available, so we will specify <code class="docutils literal notranslate"><span class="pre">&quot;cpu&quot;</span></code> as the device for the arrays in order to run on a Intel® Xeon 4th Generation CPU. Even though it is running on CPU like NumPy, it has SYCL and oneAPI optimizations underneath it to give it more performance.</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[11]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1">#using dpnp to allow heterogenous computing of NumPy!</span>
<span class="kn">import</span> <span class="nn">dpnp</span> <span class="k">as</span> <span class="nn">np</span>
<span class="c1">#import numpy as np</span>

<span class="kn">import</span> <span class="nn">time</span>

<span class="c1">#compute pairwise distance</span>
<span class="k">def</span> <span class="nf">pairwise_distance</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">distance</span><span class="p">):</span>
    <span class="n">data_sqr</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">square</span><span class="p">(</span><span class="n">data</span><span class="p">),</span> <span class="n">dtype</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span> <span class="c1">#specify cpu as the device</span>
    <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">data</span><span class="o">.</span><span class="n">T</span><span class="p">,</span> <span class="n">distance</span><span class="p">)</span>
    <span class="n">distance</span> <span class="o">*=</span> <span class="o">-</span><span class="mi">2</span>
    <span class="n">np</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">distance</span><span class="p">,</span> <span class="n">data_sqr</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">data_sqr</span><span class="o">.</span><span class="n">size</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span> <span class="n">distance</span><span class="p">)</span>
    <span class="n">np</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">distance</span><span class="p">,</span> <span class="n">data_sqr</span><span class="p">,</span> <span class="n">distance</span><span class="p">)</span>
    <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">distance</span><span class="p">,</span> <span class="n">distance</span><span class="p">)</span>

<span class="c1">#specify CPU device type to run on CPU</span>
<span class="n">data</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">ranf</span><span class="p">((</span><span class="mi">10</span><span class="o">*</span><span class="mi">1024</span><span class="p">,</span><span class="mi">3</span><span class="p">),</span> <span class="n">device</span> <span class="o">=</span> <span class="s2">&quot;cpu&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
<span class="n">distance</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">(</span><span class="n">shape</span><span class="o">=</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">data</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">,</span> <span class="n">device</span> <span class="o">=</span> <span class="s2">&quot;cpu&quot;</span><span class="p">)</span>


<span class="c1">#do compilation of kernel first run, we will calculate performance on subsequent runs</span>
<span class="n">pairwise_distance</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">distance</span><span class="p">)</span>
<span class="c1">#time pairwise distance calculations</span>
<span class="n">start</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
<span class="n">pairwise_distance</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">distance</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Time to Compute Pairwise Distance with DPNP on CPU:&quot;</span><span class="p">,</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">start</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
Time to Compute Pairwise Distance with DPNP on CPU: 0.2046055793762207
</pre></div></div>
</div>
<p>We already see some speedup just by using DPNP on CPU!</p>
</section>
<section id="Data-Parallel-Extension-for-NumPy*-Running-on-Intel-GPU">
<h2>Data Parallel Extension for NumPy* Running on Intel GPU<a class="headerlink" href="#Data-Parallel-Extension-for-NumPy*-Running-on-Intel-GPU" title="Link to this heading">¶</a></h2>
<p>Now instead of running this script on Intel CPU, let’s run it on a Intel® Data Center GPU Max Series GPU. Since dpnp will use a Intel GPUS SYCL-device by device if it’s available, we can remove the device parameter from our calls.</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[14]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1">#using dpnp to allow heterogenous computing of NumPy!</span>
<span class="kn">import</span> <span class="nn">dpnp</span> <span class="k">as</span> <span class="nn">np</span>
<span class="c1">#import numpy as np</span>

<span class="kn">import</span> <span class="nn">time</span>

<span class="c1">#compute pairwise distance</span>
<span class="k">def</span> <span class="nf">pairwise_distance</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">distance</span><span class="p">):</span>
    <span class="n">data_sqr</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">square</span><span class="p">(</span><span class="n">data</span><span class="p">),</span> <span class="n">dtype</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span> <span class="c1">#specify cpu as the device</span>
    <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">data</span><span class="o">.</span><span class="n">T</span><span class="p">,</span> <span class="n">distance</span><span class="p">)</span>
    <span class="n">distance</span> <span class="o">*=</span> <span class="o">-</span><span class="mi">2</span>
    <span class="n">np</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">distance</span><span class="p">,</span> <span class="n">data_sqr</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">data_sqr</span><span class="o">.</span><span class="n">size</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span> <span class="n">distance</span><span class="p">)</span>
    <span class="n">np</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">distance</span><span class="p">,</span> <span class="n">data_sqr</span><span class="p">,</span> <span class="n">distance</span><span class="p">)</span>
    <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">distance</span><span class="p">,</span> <span class="n">distance</span><span class="p">)</span>

<span class="c1">#no device specification necessary, by default it will run on Intel GPU SYCL-device if available</span>
<span class="n">data</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">ranf</span><span class="p">((</span><span class="mi">10</span><span class="o">*</span><span class="mi">1024</span><span class="p">,</span><span class="mi">3</span><span class="p">))</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
<span class="n">distance</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">(</span><span class="n">shape</span><span class="o">=</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">data</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>


<span class="c1">#do compilation of kernel first run, we will calculate performance on subsequent runs</span>
<span class="n">pairwise_distance</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">distance</span><span class="p">)</span>
<span class="c1">#time pairwise distance calculations</span>
<span class="n">start</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
<span class="n">pairwise_distance</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">distance</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Time to Compute Pairwise Distance with DPNP on GPU:&quot;</span><span class="p">,</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">start</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
Time to Compute Pairwise Distance with DPNP on GPU: 0.012220144271850586
</pre></div></div>
</div>
<p>Look at that great speedup! All done by a line of code to allow heterogenous computing.</p>
<p>You can specify the device that you would like to execute on if you have a preferred device. See more in the <a class="reference external" href="https://intelpython.github.io/dpnp/">dpnp documentation</a>.</p>
</section>
<section id="Data-Parallel-Extension-for-Numba*-Enhanced-DPNP-Script-for-Further-Performance-and-Compilation-on-Intel-GPU">
<h2>Data Parallel Extension for Numba* Enhanced DPNP Script for Further Performance and Compilation on Intel GPU<a class="headerlink" href="#Data-Parallel-Extension-for-Numba*-Enhanced-DPNP-Script-for-Further-Performance-and-Compilation-on-Intel-GPU" title="Link to this heading">¶</a></h2>
</section>
<section id="Numba-Performance-Gains-Made-Easy-on-any-SYCL-device">
<h2>Numba Performance Gains Made Easy on any SYCL device<a class="headerlink" href="#Numba-Performance-Gains-Made-Easy-on-any-SYCL-device" title="Link to this heading">¶</a></h2>
<p>With Data Parallel Extension for Numba* (numba-dpex), you can now run Python code with the Numba-JIT compiler to take advantage of these optimizations on any SYCL device, including Intel GPU!</p>
<p>Let’s try it out with the <code class="docutils literal notranslate"><span class="pre">&#64;dpjit</span></code> function decorator, similar to the Numba <code class="docutils literal notranslate"><span class="pre">&#64;jit</span></code> decorator in allowing JIT compilation but on any SYCL device rather than just CPU.</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[15]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">dpnp</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">from</span> <span class="nn">numba</span> <span class="kn">import</span> <span class="n">prange</span>
<span class="kn">from</span> <span class="nn">numba_dpex</span> <span class="kn">import</span> <span class="n">dpjit</span>
<span class="kn">import</span> <span class="nn">time</span>

<span class="nd">@dpjit</span> <span class="c1">#using Numba JIT compiler optimizations, now on any SYCL device</span>
<span class="k">def</span> <span class="nf">pairwise_distance</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">distance</span><span class="p">):</span>
    <span class="n">float0</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">dtype</span><span class="o">.</span><span class="n">type</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>

    <span class="c1">#prange used for parallel loops for further opt</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">prange</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]):</span>
        <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]):</span>
            <span class="n">d</span> <span class="o">=</span> <span class="n">float0</span>
            <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]):</span>
                <span class="n">d</span> <span class="o">+=</span> <span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">k</span><span class="p">]</span> <span class="o">-</span> <span class="n">data</span><span class="p">[</span><span class="n">j</span><span class="p">,</span> <span class="n">k</span><span class="p">])</span><span class="o">**</span><span class="mi">2</span>

            <span class="n">distance</span><span class="p">[</span><span class="n">j</span><span class="p">,</span> <span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">d</span><span class="p">)</span>

<span class="n">data</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">ranf</span><span class="p">((</span><span class="mi">10</span><span class="o">*</span><span class="mi">1024</span><span class="p">,</span><span class="mi">3</span><span class="p">))</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
<span class="n">distance</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">(</span><span class="n">shape</span><span class="o">=</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">data</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>

<span class="c1">#do compilation first run, we will calculate performance on subsequent runs</span>
<span class="c1">#wrapper consistent with previous np and dpnp scripts</span>
<span class="n">pairwise_distance</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">distance</span><span class="p">)</span>

<span class="c1">#time pairwise distance calculations</span>
<span class="n">start</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
<span class="n">pairwise_distance</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">distance</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Time to Compute Pairwise Distance with DPNP and Numba-DPEX on GPU:&quot;</span><span class="p">,</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">start</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
Time to Compute Pairwise Distance with DPNP and Numba-DPEX on GPU: 0.007500171661376953
</pre></div></div>
</div>
<p>Wow, even more speedup than in our previous DPNP script from compilation optimizations and SYCL!</p>
<section id="For-advanced-programmers:-SYCL-Programming-Made-Simple-by-Data-Parallel-Extension-for-Numba*">
<h3>For advanced programmers: SYCL Programming Made Simple by Data Parallel Extension for Numba*<a class="headerlink" href="#For-advanced-programmers:-SYCL-Programming-Made-Simple-by-Data-Parallel-Extension-for-Numba*" title="Link to this heading">¶</a></h3>
<p>For more advanced programmers, Python developers may want to take advantage of Numba-JIT optimizations and write efficient kernel functions for even more speed-up with DPNP scripts.</p>
<p>Now you can write SYCL kernels directly with the <code class="docutils literal notranslate"><span class="pre">&#64;dpex.kernel</span></code> function decorator to use DPC++ SYCL run-time and compilation for near-native speed. No DPC++ SYCL language coding required!</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[16]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">dpnp</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">numba_dpex</span> <span class="k">as</span> <span class="nn">dpex</span>
<span class="kn">import</span> <span class="nn">time</span>

<span class="c1"># kernel programming similar to Numba&#39;s cuda.jit sub-module</span>
<span class="c1"># API modeled after SYCL lanaguage and uses the DPC++ run-time</span>
<span class="nd">@dpex</span><span class="o">.</span><span class="n">kernel</span>
<span class="k">def</span> <span class="nf">_pairwise_distance_kernel</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">distance</span><span class="p">):</span>
    <span class="n">i</span> <span class="o">=</span> <span class="n">dpex</span><span class="o">.</span><span class="n">get_global_id</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
    <span class="n">j</span> <span class="o">=</span> <span class="n">dpex</span><span class="o">.</span><span class="n">get_global_id</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>

    <span class="n">data_dims</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>

    <span class="n">d</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">dtype</span><span class="o">.</span><span class="n">type</span><span class="p">(</span><span class="mf">0.0</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">data_dims</span><span class="p">):</span>
        <span class="n">tmp</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">k</span><span class="p">]</span> <span class="o">-</span> <span class="n">data</span><span class="p">[</span><span class="n">j</span><span class="p">,</span> <span class="n">k</span><span class="p">]</span>
        <span class="n">d</span> <span class="o">+=</span> <span class="n">tmp</span> <span class="o">*</span> <span class="n">tmp</span>

    <span class="n">distance</span><span class="p">[</span><span class="n">j</span><span class="p">,</span> <span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">d</span><span class="p">)</span>

<span class="c1"># for this example, let&#39;s put the kernel we just wrote in a wrapper to call it for consistency with our previous scipts</span>
<span class="c1"># you can call the kernel directly as well</span>
<span class="k">def</span> <span class="nf">pairwise_distance</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">distance</span><span class="p">):</span>
    <span class="n">_pairwise_distance_kernel</span><span class="p">[</span><span class="n">dpex</span><span class="o">.</span><span class="n">Range</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">data</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">])](</span><span class="n">data</span><span class="p">,</span> <span class="n">distance</span><span class="p">)</span>


<span class="n">data</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">ranf</span><span class="p">((</span><span class="mi">10</span><span class="o">*</span><span class="mi">1024</span><span class="p">,</span><span class="mi">3</span><span class="p">))</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
<span class="n">distance</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">(</span><span class="n">shape</span><span class="o">=</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">data</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>


<span class="c1">#do compilation first run, we will calculate performance on subsequent runs</span>
<span class="c1">#wrapper consistent with previous np and dpnp scripts</span>
<span class="n">pairwise_distance</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">distance</span><span class="p">)</span>

<span class="c1"># alternatively, call kernel directly without wrapper:</span>
<span class="c1">#_pairwise_distance_kernel[dpex.Range(data.shape[0], data.shape[0])](data, distance)</span>

<span class="c1">#time pairwise distance calculations</span>
<span class="n">start</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
<span class="n">pairwise_distance</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">distance</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Time to Compute Pairwise Distance with DPNP and Numba-DPEX written SYCL Kernel on GPU:&quot;</span><span class="p">,</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">start</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
Time to Compute Pairwise Distance with DPNP and Numba-DPEX written SYCL Kernel on GPU: 0.005505800247192383
</pre></div></div>
</div>
</section>
</section>
<section id="For-more-information-on-Data-Parallel-Extensions-for-Python*-language,-please-visit:">
<h2>For more information on Data Parallel Extensions for Python* language, please visit:<a class="headerlink" href="#For-more-information-on-Data-Parallel-Extensions-for-Python*-language,-please-visit:" title="Link to this heading">¶</a></h2>
<ul class="simple">
<li><p><a class="reference external" href="https://intelpython.github.io/DPEP/main/">Data Parallel Extensions for Python* language (dpep) Website</a></p></li>
<li><p><a class="reference external" href="https://intelpython.github.io/dpnp/">Data Parallel Extension for NumPy* (dpnp) Documentation</a></p></li>
<li><p><a class="reference external" href="https://intelpython.github.io/numba-dpex/latest/index.html">Data Parallel Extension for Numba* (numba-dpex) Documentation</a></p></li>
<li><p><a class="reference external" href="https://intelpython.github.io/dpctl/latest/index.html">Data Parallel Control (dpctl) Documentation</a></p></li>
</ul>
<p>For support: <a class="reference external" href="https://community.intel.com/t5/Intel-Distribution-for-Python/bd-p/distribution-python">Intel Machine Learning and Data Analytics Support Forum</a></p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[ ]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>
</pre></div>
</div>
</div>
</section>
</section>


            <div class="clearer"></div>
          </div>
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper"><h3>Table of Contents</h3>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../prerequisites_and_installation.html">Prerequisites and Installation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../parallelism.html">Parallelism in Modern Data-Parallel Architectures</a></li>
<li class="toctree-l1"><a class="reference internal" href="../heterogeneous_computing.html">Heterogeneous Computing</a></li>
<li class="toctree-l1"><a class="reference internal" href="../programming_dpep.html">Programming with Data Parallel Extensions for Python</a></li>
<li class="toctree-l1"><a class="reference internal" href="../examples.html">Examples</a></li>
<li class="toctree-l1"><a class="reference internal" href="../jupyter_notebook.html">Tutorials</a></li>
<li class="toctree-l1"><a class="reference internal" href="../benchmarks.html">Benchmarks</a></li>
<li class="toctree-l1"><a class="reference internal" href="../demos.html">Demos</a></li>
<li class="toctree-l1"><a class="reference internal" href="../useful_links.html">Useful links</a></li>
<li class="toctree-l1"><a class="reference internal" href="../useful_links.html#to-do">To-Do</a></li>
</ul>

<form action="../search.html" method="get">
  <input type="text" name="q" placeholder="Search" />
  <input type="hidden" name="check_keywords" value="yes" />
  <input type="hidden" name="area" value="default" />
</form>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
<footer class="footer">
  <p class="pull-right"> &nbsp;
    <a href="#">Back to Top</a></p>
  <p>
    &copy; Copyright 2020-2023, Intel Corporation.<br/>
    Created using <a href="http://www.sphinx-doc.org/en/stable/">Sphinx</a> 7.2.6. &nbsp;
  </p>
</footer>
  </body>
</html>